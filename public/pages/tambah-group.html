<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tambah Group | Smart Kominfo</title>

  <style>
    :root{
      --primary:#0a1f8f;
      --primary-dark:#081870;

      --panel:#f6f3f3;
      --border:#cfcfcf;
      --shadow:0 4px 10px rgba(0,0,0,.18);

      --text:#2b2b2b;
      --muted:#8f8f8f;

      --radius:4px;
    }

    *{box-sizing:border-box}
    body{margin:0;font-family: Arial, Helvetica, sans-serif;background:#fff;color:var(--text);}

    .topbar{
      height:72px;background:var(--primary);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:800;font-size:28px;letter-spacing:.2px;
    }

    main{max-width:1100px;margin:0 auto;padding:26px 22px 70px;}

    .card{
      background:var(--panel);
      border:1px solid #e1e1e1;
      border-radius:3px;
      box-shadow:var(--shadow);
      padding:34px 44px 46px;
      min-height:520px;
    }

    h2{margin:0 0 14px;font-size:22px;font-weight:900;color:#2c2c2c;}
    .section{margin-bottom:26px;}

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:26px 46px;

      /* UPDATED: biar Area/Zone sejajar dengan Device ID (tidak ikut turun karena tombol cek koneksi) */
      align-items:start;
    }

    label{display:block;margin:0 0 8px;font-size:18px;font-weight:700;color:#7b7b7b;}

    input{
      width:100%;
      height:38px;
      border:1px solid var(--border);
      border-radius:3px;
      padding:0 12px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    input::placeholder{color:#b7b7b7}

    .row-actions{display:flex;align-items:center;gap:12px;margin-top:12px;}

    .badge{
      display:none;
      padding:6px 10px;
      border-radius:3px;
      font-weight:800;
      font-size:12px;
      background:#7be087;
      color:#0c6a22;
      box-shadow:0 2px 6px rgba(0,0,0,.12);
      min-width:92px;
      text-align:center;
    }
    .badge.err{background:#ffdddd;color:#9a1414;}

    .btn-row{display:flex;justify-content:center;margin-top:26px;}
    .btn{
      background:var(--primary);
      color:#fff;border:none;border-radius:4px;
      font-weight:800;
      padding:10px 44px;
      font-size:18px;
      cursor:pointer;
      box-shadow:0 2px 6px rgba(0,0,0,.18);
    }
    .btn:hover{background:var(--primary-dark)}
    .btn:active{transform:translateY(1px)}
    .btn:disabled{opacity:.7;cursor:not-allowed}
    .btn.small{padding:10px 18px;font-size:16px}
    .btn-danger{background:#b11b1b;}
    .btn-danger:hover{background:#8f1414;}

    .table-wrap{
      background:#fff;
      border:1px solid #e1e1e1;
      border-radius:3px;
      overflow:hidden;
      box-shadow:0 2px 6px rgba(0,0,0,.08);
    }
    table{width:100%;border-collapse:collapse;}
    thead th{
      text-align:left;
      padding:10px 14px;
      background:#efefef;
      border-bottom:1px solid #ddd;
      font-weight:900;
    }
    tbody td{
      padding:10px 14px;
      border-bottom:1px solid #eee;
      vertical-align:middle;
    }
    tbody tr:last-child td{border-bottom:none;}

    .tips{margin-top:10px;color:#666;font-size:13px;}

    .msg{
      display:none;
      margin:0 0 14px;
      padding:10px 12px;
      border-radius:4px;
      font-size:14px;
      background:#fff;
      border:1px solid #ddd;
      color:#444;
    }
    .msg.ok{border-color:#37b36b;color:#1c7f45;background:#f2fff7;}
    .msg.err{border-color:#e34b4b;color:#a01818;background:#fff2f2;}

    @media (max-width: 900px){
      .card{padding:26px 18px}
      .grid{grid-template-columns:1fr; gap:18px}
      .btn{width:100%; max-width:320px}
    }

  </style>
</head>

<body>
  <header class="topbar">Tambah Group</header>

  <main>
    <section class="card">
      <div id="msg" class="msg"></div>

      <form id="groupForm">
        <div class="section">
          <h2>Informasi Group</h2>
          <div class="grid">
            <div>
              <label for="namaGroup">Nama Group</label>
              <input id="namaGroup" type="text" placeholder="Masukkan Nama">
            </div>

            <div>
              <label for="lokasi">Lokasi</label>
              <input id="lokasi" type="text" placeholder="Ketikkan Lokasi">
            </div>
          </div>
        </div>

        <div class="section">
          <h2>Informasi Perangkat</h2>
          <div class="grid">
            <div>
              <label for="deviceId">Device ID</label>
              <input id="deviceId" type="text" placeholder="Masukkan Device ID">

              <div class="row-actions">
                <button class="btn small" type="button" onclick="cekKoneksi()">Cek Koneksi</button>
                <span id="connBadge" class="badge">Connected</span>
              </div>
            </div>

            <div>
              <label for="area">Area/Zone</label>
              <input id="area" type="text" placeholder="Ketik Area/Zone (contoh: Pahlawan)">
            </div>
          </div>

          <div style="margin-top:18px;">
            <label for="tuyaCode">Tuya Code (untuk ON/OFF group)</label>
            <input id="tuyaCode" type="text" placeholder="default: switch_1" value="switch_1">
            <div class="tips">
              Karena semua lampu bareng, cukup 1 code saja (biasanya <b>switch_1</b>).
            </div>
          </div>
        </div>

        <div class="section">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:10px;">
            <h2 style="margin:0;">Daftar Lampu dalam Group</h2>
            <button class="btn small" type="button" onclick="addLampRow()">+ Tambah Lampu</button>
          </div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Nama Lampu</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody id="lampTbody"></tbody>
            </table>
          </div>

          <div class="tips">
            Semua lampu di group ini akan ikut status ON/OFF dari device yang sama.
          </div>
        </div>

        <div class="btn-row">
          <button class="btn" type="submit" id="btnSave">Simpan</button>
        </div>
      </form>
    </section>
  </main>

  <script src="../js/api.js"></script>
  <script src="../js/auth.js"></script>
  <script>
    requireAuth();

    function showMsg(type, text){
      const el = document.getElementById('msg');
      el.className = 'msg ' + (type === 'ok' ? 'ok' : 'err');
      el.textContent = text;
      el.style.display = 'block';
    }

    function escapeHtml(str){
      return String(str ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    function addLampRow(nameVal = ''){
      const tbody = document.getElementById('lampTbody');
      const tr = document.createElement('tr');
      tr.className = 'lamp-row';

      tr.innerHTML = `
        <td>
          <input class="lamp-nama" type="text" placeholder="Contoh: Lampu ${tbody.children.length + 1}" value="${escapeHtml(nameVal)}">
        </td>
        <td>
          <button class="btn small btn-danger" type="button" onclick="removeLampRow(this)">Hapus</button>
        </td>
      `;
      tbody.appendChild(tr);
    }

    function removeLampRow(btn){
      btn.closest('tr').remove();
    }

    window.addLampRow = addLampRow;
    window.removeLampRow = removeLampRow;

    // row default
    addLampRow('Lampu 1');

    async function cekKoneksi(){
      const device_id = document.getElementById('deviceId').value.trim();
      const badge = document.getElementById('connBadge');
      badge.style.display = 'none';
      badge.classList.remove('err');

      if(!device_id){
        showMsg('err', 'Isi Device ID dulu.');
        return;
      }

      try{
        const res = await apiFetch('/tuya/check.php?device_id=' + encodeURIComponent(device_id));
        badge.textContent = 'Connected';
        badge.style.display = 'inline-block';
        showMsg('ok', res.message || 'Connected');
      }catch(err){
        badge.textContent = 'Gagal';
        badge.classList.add('err');
        badge.style.display = 'inline-block';
        showMsg('err', err.message);
      }
    }
    window.cekKoneksi = cekKoneksi;

    document.getElementById('groupForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const nama_group = document.getElementById('namaGroup').value.trim();
      const lokasi = document.getElementById('lokasi').value.trim();
      const device_id = document.getElementById('deviceId').value.trim();
      const area_zone = document.getElementById('area').value.trim();
      const tuya_code = document.getElementById('tuyaCode').value.trim() || 'switch_1';

      if(!nama_group || !lokasi || !device_id || !area_zone){
        showMsg('err', 'Nama group, lokasi, device ID, dan area/zone wajib diisi.');
        return;
      }

      const lamps = Array.from(document.querySelectorAll('.lamp-row')).map(r => ({
        nama_lampu: r.querySelector('.lamp-nama').value.trim(),
      })).filter(x => x.nama_lampu);

      if(!lamps.length){
        showMsg('err', 'Minimal 1 lampu di dalam group.');
        return;
      }

      const btn = document.getElementById('btnSave');
      btn.disabled = true;
      btn.textContent = 'Menyimpan...';

      try{
        const res = await apiFetch('/groups/create.php', {
          method: 'POST',
          body: { nama_group, lokasi, device_id, area_zone, tuya_code, lamps }
        });

        showMsg('ok', res.message || 'Group berhasil disimpan');
        setTimeout(() => window.location.href = 'device-group.html', 600);

      }catch(err){
        showMsg('err', err.message);
      }finally{
        btn.disabled = false;
        btn.textContent = 'Simpan';
      }
    });
  </script>
</body>
</html>
