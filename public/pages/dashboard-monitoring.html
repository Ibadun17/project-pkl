<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Monitoring | Smart Kominfo</title>

  <style>
    :root{
      --primary:#0a1f8f;
      --primary-dark:#081870;
      --text:#2b2b2b;
      --muted:#6f6f6f;
      --panel:#f6f3f3;
      --panel-2:#f1f1f1;
      --border:#d7d7d7;
      --shadow:0 4px 10px rgba(0,0,0,.18);
      --blue:#78b9ff;
      --blue-dark:#2f7fe0;
      --on:#2fa86a;
      --off:#e34b4b;
      --radius:4px;
    }

    *{box-sizing:border-box}
    body{margin:0;font-family: Arial, Helvetica, sans-serif;background:#fff;color:var(--text);}

    .topbar{
      height:72px;background:var(--primary);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:800;font-size:26px;letter-spacing:.2px;
    }

    main{padding:18px 22px 60px;max-width:1100px;margin:0 auto;}

    .search-wrap{
      background:var(--panel);
      border:1px solid #e3e3e3;
      border-radius:3px;
      padding:10px 14px;
      display:flex;align-items:center;gap:10px;
      box-shadow:0 2px 6px rgba(0,0,0,.08);
    }
    .search-wrap svg{flex:0 0 auto; opacity:.6}
    .search{width:100%;border:none;outline:none;background:transparent;font-size:18px;color:#777;}
    .search::placeholder{color:#a9a9a9}

    .stats{
      margin:34px auto 26px;
      display:grid;
      grid-template-columns: repeat(3, minmax(220px, 1fr));
      gap:28px;
      max-width:860px;
    }

    .stat-card{
      background:var(--panel);
      border:1px solid #e3e3e3;
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:18px 18px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:16px;
      min-height:92px;
      position:relative;
    }
    .stat-card::after{
      content:"";
      position:absolute;
      left:0; right:0; bottom:0;
      height:3px;
      background:#9aa6ff;
      border-bottom-left-radius:var(--radius);
      border-bottom-right-radius:var(--radius);
      opacity:.9;
    }

    .stat-icon{width:52px;height:52px;display:grid;place-items:center;color:var(--blue-dark);}

    .stat-num{font-size:40px;font-weight:900;color:#3a3f8f;line-height:1;text-align:center;}
    .stat-label{text-align:center;margin-top:2px;color:#4d57b2;font-size:14px;}

    .table-panel{
      margin: 0 auto;
      background:var(--panel-2);
      border:1px solid var(--border);
      border-radius:3px;
      box-shadow: var(--shadow);
      overflow:hidden;
      max-width:980px;
    }

    table{width:100%;border-collapse:collapse;}
    thead th{
      text-align:left;
      padding:12px 18px;
      background:#efefef;
      border-bottom:2px solid var(--border);
      font-size:22px;
      font-weight:800;
      color:#2c2c2c;
      white-space:nowrap;
    }
    tbody td{
      padding:10px 18px;
      border-bottom:2px solid #dbdbdb;
      background:#f6f6f6;
      font-size:18px;
      color:#2f2f2f;
      vertical-align:middle;
    }

    .badge{
      display:inline-block;
      min-width:52px;
      text-align:center;
      padding:3px 10px;
      font-weight:800;
      color:#fff;
      border-radius:2px;
    }
    .badge.on{background:var(--on)}
    .badge.off{background:var(--off)}

    .toggle{
      --h:28px;--w:54px;
      position:relative;
      display:inline-block;
      width:var(--w);
      height:var(--h);
    }
    .toggle input{display:none}
    .slider{
      position:absolute;
      inset:0;
      border-radius:999px;
      background:#d9ecff;
      border:2px solid #6aaeff;
      transition:.2s;
    }
    .slider:before{
      content:"";
      position:absolute;
      width:22px;height:22px;
      left:3px;top:50%;
      transform:translateY(-50%);
      border-radius:50%;
      background:#fff;
      border:2px solid #3e86e6;
      transition:.2s;
    }
    .toggle input:checked + .slider{background:#7dbdff;border-color:#3e86e6;}
    .toggle input:checked + .slider:before{left:calc(100% - 25px);}

    .muted{color:#9a9a9a}

    .msg{
      display:none;
      margin:14px 0 0;
      padding:10px 12px;
      border-radius:4px;
      font-size:14px;
      background:#fff;
      border:1px solid #ddd;
      color:#444;
      max-width:980px;
    }
    .msg.err{border-color:#e34b4b;color:#a01818;background:#fff2f2;}
    .msg.ok{border-color:#37b36b;color:#1c7f45;background:#f2fff7;}

    @media (max-width: 900px){
      .stats{grid-template-columns:1fr; max-width:520px}
      thead th{font-size:16px}
      tbody td{font-size:14px}
      .search{font-size:16px}
    }
  </style>
</head>

<body>
  <header class="topbar">Dashboard Monitoring</header>

  <main>
    <div class="search-wrap" role="search">
      <svg width="26" height="26" viewBox="0 0 24 24" aria-hidden="true">
        <path fill="#666" d="M10 2a8 8 0 105.293 14.293l4.207 4.207 1.414-1.414-4.207-4.207A8 8 0 0010 2zm0 2a6 6 0 110 12 6 6 0 010-12z"/>
      </svg>
      <input id="search" class="search" type="text" placeholder="Cari device, lokasi, group..." />
    </div>

    <div id="msg" class="msg"></div>

    <section class="stats" aria-label="Ringkasan Monitoring">
      <div class="stat-card">
        <div class="stat-icon" aria-hidden="true">
          <svg width="44" height="44" viewBox="0 0 24 24">
            <path fill="none" stroke="#2f7fe0" stroke-width="1.8" d="M9 21h6m-6-3h6m-3-2c0-1.6 3-2.6 3-6a6 6 0 10-12 0c0 3.4 3 4.4 3 6"/>
            <circle cx="12" cy="12" r="3" stroke="#2f7fe0" stroke-width="2" fill="none"/>
          </svg>
        </div>
        <div>
          <div class="stat-num" id="statTotal">0</div>
          <div class="stat-label">Total Lampu</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon" aria-hidden="true">
          <label class="toggle" title="Lampu ON (ikon)">
            <input type="checkbox" checked disabled>
            <span class="slider"></span>
          </label>
        </div>
        <div>
          <div class="stat-num" id="statOn">0</div>
          <div class="stat-label">Lampu ON</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon" aria-hidden="true">
          <label class="toggle" title="Lampu OFF (ikon)">
            <input type="checkbox" disabled>
            <span class="slider"></span>
          </label>
        </div>
        <div>
          <div class="stat-num" id="statOff">0</div>
          <div class="stat-label">Lampu OFF</div>
        </div>
      </div>
    </section>

    <section class="table-panel" aria-label="Tabel Monitoring Lampu">
      <table id="lampTable">
        <thead>
          <tr>
            <th>Lampu</th>
            <th>Area</th>
            <th>Status</th>
            <th>Last Update</th>
            <th>Tegangan</th>
            <th>Tombol</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="6" class="muted">Loading...</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <script src="../js/api.js"></script>
  <script src="../js/auth.js"></script>
  <script>
    requireAuth();

    let devices = [];

    function showMsg(type, text){
      const el = document.getElementById('msg');
      el.className = 'msg ' + (type === 'ok' ? 'ok' : 'err');
      el.textContent = text;
      el.style.display = 'block';
    }

    function fmtTime(ts){
      if(!ts) return '-';
      return String(ts).replace('T',' ').slice(0,19);
    }

    function normalizeStatus(v){
      if (v === true) return 'ON';
      if (v === false) return 'OFF';
      const up = String(v || '').toUpperCase();
      return up === 'ON' ? 'ON' : 'OFF';
    }

    function recalcStats(list){
      const total = list.length;
      const on = list.filter(d => normalizeStatus(d.status_terakhir) === 'ON').length;
      const off = total - on;
      document.getElementById('statTotal').textContent = total;
      document.getElementById('statOn').textContent = on;
      document.getElementById('statOff').textContent = off;
    }

    function escapeHtml(str){
      return String(str ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    function rowHtml(d){
      const lampu = d.nama_perangkat || `Device ${d.device_id}`;
      const area = d.lokasi || '-';
      const status = normalizeStatus(d.status_terakhir);
      const v = d.tegangan_terakhir ? `${d.tegangan_terakhir}V` : '-';
      const updated = d.updated_at ? fmtTime(d.updated_at) : '-';
      const code = d.switch_code || d.fungsi || 'switch_1';

      return `
        <tr>
          <td>${escapeHtml(lampu)}</td>
          <td>${escapeHtml(area)}</td>
          <td><span class="badge ${status === 'ON' ? 'on' : 'off'}">${status}</span></td>
          <td>${escapeHtml(updated)}</td>
          <td>${escapeHtml(v)}</td>
          <td>
            <label class="toggle" title="Toggle status">
              <input
                type="checkbox"
                ${status === 'ON' ? 'checked' : ''}
                data-device-id="${escapeHtml(d.device_id)}"
                data-code="${escapeHtml(code)}"
                onchange="toggleStatus(this)"
              >
              <span class="slider"></span>
            </label>
          </td>
        </tr>
      `;
    }

    function render(list){
      const tbody = document.getElementById('tbody');
      if(!list.length){
        tbody.innerHTML = `<tr><td colspan="6" class="muted">Belum ada device. Tambahkan di menu Tambah Device.</td></tr>`;
        recalcStats(list);
        return;
      }
      tbody.innerHTML = list.map(rowHtml).join('');
      recalcStats(list);
    }

    function renderFiltered(){
      const q = document.getElementById('search').value.toLowerCase().trim();
      const filtered = devices.filter(d => {
        const hay = [
          d.device_id, d.nama_perangkat, d.lokasi, d.fungsi, d.switch_code
        ].filter(Boolean).join(' ').toLowerCase();
        return hay.includes(q);
      });
      render(filtered);
    }

    async function loadDevices(){
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = `<tr><td colspan="6" class="muted">Loading...</td></tr>`;

      try{
        const res = await apiFetch('/devices/list.php');
        devices = res.data || [];

        if(!devices.length){
          render([]);
          return;
        }

        const enriched = await Promise.all(devices.map(async (d) => {
          try{
            const rr = await apiFetch('/tuya/status.php?device_id=' + encodeURIComponent(d.device_id));
            const st = rr.data || [];

            const swCode = d.switch_code || d.fungsi || 'switch_1';
            const sw = st.find(x => x.code === swCode);

            const volt = st.find(x => x.code === 'voltage')
                      || st.find(x => x.code === 'va_voltage');

            return {
              ...d,
              status_terakhir: sw ? sw.value : false,
              tegangan_terakhir: volt ? volt.value : null,
              updated_at: new Date().toISOString()
            };
          }catch(e){
            return { ...d, status_terakhir:false, tegangan_terakhir:null, updated_at:null };
          }
        }));

        devices = enriched;
        renderFiltered();
      }catch(err){
        showMsg('err', err.message);
        tbody.innerHTML = `<tr><td colspan="6" class="muted">Gagal memuat data.</td></tr>`;
        document.getElementById('statTotal').textContent = '0';
        document.getElementById('statOn').textContent = '0';
        document.getElementById('statOff').textContent = '0';
      }
    }

    // âœ… Toggle ON/OFF -> kirim ke Tuya
    async function toggleStatus(cb){
      const device_id = cb.getAttribute('data-device-id');
      const code = cb.getAttribute('data-code') || 'switch_1';
      const status = cb.checked ? 'ON' : 'OFF';

      // optimistik UI
      const tr = cb.closest('tr');
      const badge = tr.querySelector('.badge');
      badge.textContent = status;
      badge.classList.toggle('on', status === 'ON');
      badge.classList.toggle('off', status === 'OFF');

      cb.disabled = true;
      try{
        // ðŸ”¥ pastikan ini menuju api/tuya/switch.php (apiFetch sudah otomatis /api)
        await apiFetch('/tuya/switch.php', {
          method: 'POST',
          body: { device_id, status, code }
        });

        // reload data dari tuya biar akurat
        await loadDevices();
      }catch(err){
        showMsg('err', err.message);

        // rollback
        cb.checked = !cb.checked;
        const rollback = cb.checked ? 'ON' : 'OFF';
        badge.textContent = rollback;
        badge.classList.toggle('on', rollback === 'ON');
        badge.classList.toggle('off', rollback === 'OFF');
      }finally{
        cb.disabled = false;
      }
    }

    window.toggleStatus = toggleStatus;

    document.getElementById('search').addEventListener('input', renderFiltered);
    loadDevices();
  </script>
</body>
</html>
